# Скрипты автоматизации для дронов

Система автоматизации для управления роем дронов через SSH.

## Файлы

### Конфигурация
- `drones.txt` - Список дронов в формате `имя:ip`
- `drone/const.py` - Константы (лидер, список дронов)

### Скрипты
- `scripts/update_drones.sh` - Обновление кода на всех дронах (git pull)
- `scripts/run_drones.sh` - Запуск скриптов на всех дронах
- `scripts/stop_drones.sh` - Остановка всех процессов Python
- `scripts/deploy_aruco_map.sh` - Развертывание ArUco карт на всех дронах
- `scripts/restart_clover.sh` - Перезапуск сервиса clover на всех дронах

## Настройка

### 1. Конфигурация дронов

Отредактируйте `drones.txt` (все в одной строке, разделитель между дронами - точка с запятой):
```
drone6:10.135.42.35;drone13:10.135.42.36;drone14:10.135.42.37;drone15:10.135.42.38
```

### 2. SSH настройки

В скриптах настройте:
```bash
SSH_USER="pi"
SSH_PASS="raspberry"  # Ваш пароль
DRONE_DIR="/home/pi/DroneCraft"
```

### 3. Установка sshpass (опционально)

Для автоматической аутентификации:
```bash
# macOS
brew install hudochenkov/sshpass/sshpass

# Ubuntu/Debian
sudo apt-get install sshpass
```

## Использование

### Обновление кода на дронах
```bash
./scripts/update_drones.sh
```

Выполняет на каждом дроне:
- `cd /home/pi/DroneCraft`
- `git pull origin main`
- Показывает статус до и после

### Запуск скриптов
```bash
# Запуск Stage1 (по умолчанию)
./scripts/run_drones.sh

# Запуск Stage1 явно
./scripts/run_drones.sh main.py

# Запуск Stage1 Mod
./scripts/run_drones.sh main_stage1_mod.py

# Запуск Stage2
./scripts/run_drones.sh stage2.py
```

**Автоматические функции:**
- ✅ **Автозапуск Log Server** - автоматически запускается перед стартом дронов
- ✅ **Автоостановка** - корректно останавливается при завершении или прерывании (Ctrl+C)
- ✅ **Проверка дубликатов** - не запускает новый log server если уже запущен

Режимы выполнения:
1. **Parallel** - все дроны одновременно (по умолчанию)
2. **Sequential** - по очереди

### Остановка процессов
```bash
./scripts/stop_drones.sh
```

Останавливает все Python процессы на дронах.

### Управление ArUco картами
```bash
# Развертывание ArUco карт
./scripts/deploy_aruco_map.sh
```

Интерактивный выбор и развертывание ArUco карт:
- **Выбор карты**: DroneCraft v1 или v2
- **Автобэкап**: создает резервную копию текущей карты
- **Проверка**: верифицирует успешное развертывание
- **Целевой путь**: `~/catkin_ws/src/clover/aruco_pose/map/small_map.txt`

### Перезапуск сервиса Clover
```bash
# Перезапуск clover на всех дронах
./scripts/restart_clover.sh
```

Безопасный перезапуск сервиса clover:
- **Остановка** → **Запуск** → **Проверка статуса**
- Применяет изменения ArUco карт
- Показывает статус сервиса после перезапуска

## Поддержка аргументов командной строки

Все main скрипты поддерживают:
```bash
# Через аргумент
python3 ./drone/main.py --drone-name=drone6

# Через переменную окружения
DRONE_NAME=drone6 python3 ./drone/main.py
```

## Структура выполнения

### Stage1 (main.py)
- Синхронизированный взлет/посадка
- Опциональная синхронизация через UDP
- Световая индикация

### Stage1 Mod (main_stage1_mod.py)
- Лидер: взлет → QR сканирование → команды фоловерам
- Фоловеры: только слушают команды лидера
- Использует skyros для связи

### Stage2 (stage2.py)
- QR рецепт крафта
- Построение 3x3 сетки
- Распределение ролей через swarm

## Логи

Все логи отправляются через UDP на сервер логов:
```bash
# Ручной запуск сервера логов (не нужен, автоматически запускается)
python3 ./drone/log_server.py
```

**Автоматическое управление логами:**
- Log server **автоматически запускается** при запуске `run_drones.sh`
- **Автоматически останавливается** при завершении работы
- Логи от всех дронов **централизованно собираются** и отображаются в реальном времени
- При прерывании (Ctrl+C) корректно **останавливает все процессы**

## Примеры команд

```bash
# Полный цикл разработки
./scripts/update_drones.sh              # Обновить код
./scripts/deploy_aruco_map.sh           # Развернуть ArUco карту
./scripts/restart_clover.sh             # Перезапустить clover
./scripts/run_drones.sh main_stage1_mod.py  # Запустить Stage1 Mod
# ... дождаться выполнения ...
./scripts/stop_drones.sh                # Остановить процессы

# Быстрая смена ArUco карты
./scripts/deploy_aruco_map.sh           # Выбрать и развернуть карту
./scripts/restart_clover.sh             # Применить изменения

# Быстрый запуск одного скрипта
./scripts/run_drones.sh main.py

# Тестирование локально
DRONE_NAME=drone6 python3 ./drone/main.py
```

## Устранение неполадок

### SSH подключение
```bash
# Проверка доступности дрона
ping 10.135.42.35

# Ручное подключение
ssh pi@10.135.42.35
```

### Логи процессов
```bash
# На дроне посмотреть запущенные процессы
ps aux | grep python

# Убить конкретный процесс
pkill -f "python.*main"
```

### Git проблемы
```bash
# На дроне сбросить изменения
cd /home/pi/DroneCraft
git reset --hard HEAD
git clean -fd
``` 