# Документация: Логика децентрализованного решения

Этот документ подробно описывает, как работает двухэтапный алгоритм для децентрализованного анализа шахматных позиций, реализованный в `drone/alg2.py`.

## Основная идея

Цель алгоритма — эффективно использовать вычислительные ресурсы нескольких дронов для принятия наилучшего решения в шахматной партии. Вместо того чтобы один дрон выполнял всю работу, мы разделяем задачу: один "мастер" быстро находит перспективные направления, а "воркеры" углубленно анализируют эти направления.

Это похоже на работу команды: менеджер (мастер) быстро определяет ключевые задачи, а затем поручает их детальную проработку специалистам (воркерам).

## Пошаговый процесс

Процесс принятия решения разделен на три основных этапа:

### Этап 1: Локальный широкий, но неглубокий поиск (на мастере)

1.  **Генерация ходов:** Мастер-дрон определяет все возможные легальные ходы из текущей позиции на доске.
2.  **Быстрая оценка:** Для каждого легального хода мастер выполняет очень быструю ("неглубокую") оценку с помощью локального движка Stockfish. На каждый ход тратится всего около 50 миллисекунд. Цель этого этапа — не найти точную оценку, а быстро отсеять очевидно плохие ходы.
3.  **Сортировка:** Все ходы сортируются по результатам быстрой оценки, от самых многообещающих до самых плохих. Эти отсортированные ходы представляют собой "ветви" дерева решений.

### Этап 2: Распределенный глубокий анализ (на воркерах)

1.  **Выбор лучших ветвей:** Мастер выбирает несколько лучших ходов (ветвей) из отсортированного списка. Количество выбираемых ходов зависит от количества доступных воркеров, чтобы максимально использовать параллелизм.
2.  **Распределение задач:** Мастер отправляет каждую из этих "ветвей" на одного из воркеров. Это делается через HTTP-запрос на эндпоинт `/evaluate` каждого воркера.
    -   **Тело запроса:** Запрос содержит позицию *после* совершения перспективного хода (`fen`) и выделенное время на глубокий анализ (`movetime`).
3.  **Глубокий анализ:** Каждый дрон-воркер, получив свою задачу, запускает свой движок Stockfish для проведения длительного и глубокого анализа этой конкретной ветви. Это самая вычислительно затратная часть процесса.

### Этап 3: Агрегация результатов и принятие решения (на мастере)

1.  **Сбор результатов:** Мастер асинхронно ожидает ответы от всех воркеров.
2.  **Сравнение оценок:** Мастер собирает точные оценки, полученные от воркеров в результате глубокого анализа.
3.  **Выбор лучшего хода:** Мастер сравнивает оценки всех проанализированных ветвей и выбирает ту, которая получила наилучшую оценку.
4.  **Финальное решение:** Ход, который привел к лучшей ветви, объявляется итоговым решением.

**Обработка ошибок:** Если по какой-то причине все воркеры не смогли вернуть результат (например, из-за проблем с сетью), мастер не "зависает". В этом случае он вернется к результатам своего первоначального локального анализа (Этап 1) и выберет самый лучший ход из них. Это делает систему более отказоустойчивой.

Этот двухэтапный подход позволяет системе быстро отбрасывать плохие варианты и концентрировать вычислительную мощность на анализе только самых перспективных ходов, что приводит к принятию более сильных и качественных решений.
